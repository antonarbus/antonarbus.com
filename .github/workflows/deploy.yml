name: 'Deploy'

# Single workflow that handles both Terraform and Docker deployment
# Steps are conditional based on what files have been changed
on:
  push:
    branches:
      - master
      - pilot
      - test
      - dev

  # Allow manual trigger in GitHub, useful to test workflow without pushing code
  workflow_dispatch:

env:
  CHANGES_DETECTED_AT: 'none' # 'terraform' | 'app' | 'both' | 'none' (set by 'Detect Changes' step)

jobs:
  deploy:
    name: 'Deploy Infrastructure and Application'
    runs-on: ubuntu-latest # OS the GitHub Actions runner (virtual machine) uses

    permissions:
      contents: read
      id-token: write

    steps:
      # To identify where a change has been made, either in code or in terraform
      # Checkout with current and previous commit to get the diff at the next step
      - name: 'Checkout repository code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 'Setup Node.js'
        uses: actions/setup-node@v4

      - name: 'Validate Config Files'
        run: bash config/validate.sh

      - name: 'Detect Environment'
        run: bash .github/scripts/detect-and-load-env-from-github-branch.sh

      - name: 'Load Config'
        run: bash .github/scripts/get-config-variables.sh ${{ env.ENVIRONMENT }} >> $GITHUB_ENV

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v3'
        with:
          workload_identity_provider: 'projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com'

      - name: 'Configuring gsutil to use gcloud credentials'
        run: gcloud config set pass_credentials_to_gsutil true

      - name: 'Detect Changes'
        run: bash .github/scripts/detect-changes.sh

      # ============================================================================
      # TERRAFORM STEPS (only if terraform files changed)
      # ============================================================================
      # Note: Terraform manages IAM permissions declaratively in main.tf
      # No need for separate permission checks - Terraform handles it

      - name: 'Setup Terraform'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: 'Set GCP Project and Enable APIs'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        run: bash .github/scripts/setup-gcp.sh

      - name: 'Terraform Format Check'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ./terraform

      - name: 'Terraform Apply with Smart Bootstrap'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        run: bash terraform.sh
        working-directory: ./terraform

      # ============================================================================
      # DOCKER STEPS (only if app files changed OR terraform was applied)
      # ============================================================================

      - name: 'Docker Auth'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: gcloud auth configure-docker '${{ env.REGION }}-docker.pkg.dev'

      - name: 'Set variable for docker tag '
        if: env.CHANGES_DETECTED_AT != 'none'
        run: echo "DOCKER_IMAGE_TAG=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: 'Build and Push Docker Image to Artifact Registry'
        if: env.CHANGES_DETECTED_AT != 'none'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfile.prod
          push: true
          tags: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}

      - name: 'Scan Image for Vulnerabilities'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: bash .github/scripts/scan-vulnerabilities.sh

      - name: 'Deploy Docker Image to Cloud Run'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: bash .github/scripts/deploy-to-cloudrun.sh

      - name: 'Verify Deployment'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: bash .github/scripts/verify-deployment.sh
