name: 'Deploy'

# Single workflow that handles both Terraform and Docker deployment
# Steps are conditional based on what files changed
on:
  push:
    branches:
      - master

  # Allow manual trigger in GitHub, useful to test workflow without pushing code
  workflow_dispatch:

env:
  # Terraform configuration
  TERRAFORM_VERSION: '1.5.0'
  TERRAFORM_DIR: './terraform'

  # GCP configuration
  PROJECT_ID: 'antonarbus'
  REGION: 'us-central1'
  ARTIFACTS_REGISTRY_NAME: 'artifact-registry'
  DOCKER_IMAGE_NAME: 'docker-image'
  SERVICE_NAME: 'cloud-run'

  # Change detection flags to enable steps conditionally (set by Detect Changes step)
  TERRAFORM_CHANGED: 'false'
  APP_CHANGED: 'false'

jobs:
  deploy:
    name: 'Deploy Infrastructure and Application'
    runs-on: ubuntu-latest # OS the GitHub Actions runner (virtual machine) uses

    permissions:
      contents: read
      id-token: write

    steps:
      # Checkout with current and previous commit to get the diff at the next step
      # To identify where a change has been made, either in code or in terraform/
      - name: 'Checkout repository code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 'Detect where changes have been made'
        run: |
          echo "Files changed in this push (between current and previous commit):"
          git diff --name-only HEAD~1 HEAD
          echo ""

          # ℹ️ Check what files changed in this push
          if git diff --name-only HEAD~1 HEAD | grep -qE '^terraform/|^\.github/workflows/deploy\.yml'; then
            echo "✅ Terraform changes detected"

            # ℹ️ Appends variable to the temp file which GitHub Actions reads and sets environment variables
            # ℹ️ $GITHUB_ENV holds the file path

            echo "TERRAFORM_CHANGED=true" >> $GITHUB_ENV 
          else
            echo "⏭️ No Terraform changes"
            echo "TERRAFORM_CHANGED=false" >> $GITHUB_ENV
          fi

          # Check if non-terraform files changed
          if git diff --name-only HEAD~1 HEAD | grep -qvE '^terraform/|^\.github/workflows/deploy\.yml'; then
            echo "✅ App code changes detected"
            echo "APP_CHANGED=true" >> $GITHUB_ENV
          else
            echo "⏭️  No app code changes"
            echo "APP_CHANGED=false" >> $GITHUB_ENV
          fi

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # ============================================================================
      # TERRAFORM STEPS (only if terraform files changed)
      # ============================================================================

      - name: 'Setup Terraform'
        if: env.TERRAFORM_CHANGED == 'true'
        # 'uses' fetches the script from GitHub which installs Terraform, adds it to PATH, makes 'terraform' command available
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: 'Set GCP Project and Enable APIs'
        if: env.TERRAFORM_CHANGED == 'true'
        run: |
          echo "Set the default project for gcloud commands"
          # ℹ️ https://cloud.google.com/sdk/gcloud/reference/config/set

          gcloud config set project ${{ env.PROJECT_ID }}

          echo "Enabling required Google Cloud APIs..."
          # ℹ️ https://cloud.google.com/sdk/gcloud/reference/services/enable

          gcloud services enable \
            iam.googleapis.com \
            cloudresourcemanager.googleapis.com \
            --project=${{ env.PROJECT_ID }}

          echo "Waiting 15s for API activation to propagate..."
          sleep 15

      - name: 'Terraform Format Check'
        if: env.TERRAFORM_CHANGED == 'true'
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: 'Terraform Init'
        if: env.TERRAFORM_CHANGED == 'true'
        run: terraform init
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: 'Terraform Validate'
        if: env.TERRAFORM_CHANGED == 'true'
        run: terraform validate -no-color
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: 'Terraform Plan'
        if: env.TERRAFORM_CHANGED == 'true'
        run: terraform plan -no-color -out=tfplan
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: 'Terraform Apply'
        if: env.TERRAFORM_CHANGED == 'true'
        id: apply
        run: |
          echo "Applying Terraform changes..."
          terraform apply -auto-approve tfplan

          echo "✅ Terraform apply completed successfully"

          echo "Outputs:"
          terraform output
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: 'Post-Terraform Summary'
        if: env.TERRAFORM_CHANGED == 'true' && always() && steps.apply.outcome != 'skipped'
        run: |
          echo "## Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.apply.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.apply.outcome }}" == "success" ]; then
            echo "✅ Infrastructure updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Infrastructure update failed" >> $GITHUB_STEP_SUMMARY
            echo "Check logs above for details" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================================================
      # DOCKER STEPS (only if app files changed OR terraform was applied)
      # ============================================================================

      - name: 'Docker Auth'
        if: env.APP_CHANGED == 'true' || env.TERRAFORM_CHANGED == 'true'
        run: |
          # Configure Docker to authenticate to Artifact Registry
          # https://cloud.google.com/sdk/gcloud/reference/auth/configure-docker
          gcloud auth configure-docker '${{ env.REGION }}-docker.pkg.dev'

      - name: 'Set Environment Variables'
        if: env.APP_CHANGED == 'true' || env.TERRAFORM_CHANGED == 'true'
        run: |
          echo "IMAGE_VERSION=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: 'Build and Push Docker Image to Artifact Registry'
        if: env.APP_CHANGED == 'true' || env.TERRAFORM_CHANGED == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfile.prod
          push: true
          tags: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACTS_REGISTRY_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_VERSION }}

      - name: 'Deploy to Cloud Run'
        if: env.APP_CHANGED == 'true' || env.TERRAFORM_CHANGED == 'true'
        run: |
          # Update Cloud Run service with new container image
          # https://cloud.google.com/sdk/gcloud/reference/run/services/update
          gcloud run services update ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACTS_REGISTRY_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_VERSION }} \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --labels managed-by=github-actions,commit-sha=${{ github.sha }}

      - name: 'Show Deployment URL'
        if: env.APP_CHANGED == 'true' || env.TERRAFORM_CHANGED == 'true'
        run: |
          echo "✅ Deployment successful!"
          # Get Cloud Run service details and extract the URL
          # https://cloud.google.com/sdk/gcloud/reference/run/services/describe
          gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --format="value(status.url)"
