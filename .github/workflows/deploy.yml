name: 'Deploy'

# Single workflow that handles both Terraform and Docker deployment
# Pushes to master automatically deploy to dev environment
# Other environments (test, pilot, prod) use image promotion workflow at GitHub
on:
  push:
    branches:
      - master

  # Allow manual trigger in GitHub, useful to test workflow without pushing code
  workflow_dispatch:

env:
  CHANGES_DETECTED_AT: 'none' # 'terraform' | 'app' | 'both' | 'none' (set by 'Detect Changes' step)

jobs:
  deploy:
    name: 'Deploy Infrastructure and Application'
    runs-on: ubuntu-latest # OS the GitHub Actions runner (virtual machine) uses

    permissions:
      contents: read
      id-token: write

    steps:
      # To identify where a change has been made, either in code or in terraform
      # Checkout with current and previous commit to get the diff at the next step
      - name: 'Checkout repository code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 'Setup Bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: 'Detect Environment'
        run: bun scripts/cli.ts detect-env

      - name: 'Validate Config Files'
        run: bun scripts/cli.ts validate

      - name: 'Load Config'
        run: bun scripts/cli.ts load-config ${{ env.ENVIRONMENT }} >> $GITHUB_ENV

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v3'
        with:
          workload_identity_provider: 'projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com'

      - name: 'Detect Changes'
        run: bun scripts/cli.ts detect-changes

      # ============================================================================
      # TERRAFORM STEPS (only if terraform files changed)
      # ============================================================================
      # Note: Terraform manages IAM permissions declaratively in main.tf
      # No need for separate permission checks - Terraform handles it

      - name: 'Setup Terraform'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: 'Set GCP Project and Enable APIs'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        run: bun scripts/cli.ts setup-gcp

      - name: 'Terraform Format Check'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ./terraform

      - name: 'Terraform Apply'
        if: env.CHANGES_DETECTED_AT == 'terraform' || env.CHANGES_DETECTED_AT == 'both'
        run: bun scripts/cli.ts terraform-apply ${{ env.ENVIRONMENT }}

      # ============================================================================
      # DOCKER STEPS (always deploys to dev - other envs use image promotion)
      # ============================================================================

      - name: 'Docker Auth'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: gcloud auth configure-docker '${{ env.REGION }}-docker.pkg.dev'

      - name: 'Set variable for docker tag '
        if: env.CHANGES_DETECTED_AT != 'none'
        run: echo "DOCKER_IMAGE_TAG=${{ env.ENVIRONMENT }}" >> $GITHUB_ENV

      - name: 'Build and Push Docker Image to Artifact Registry'
        if: env.CHANGES_DETECTED_AT != 'none'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfile.prod
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.ENVIRONMENT }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: 'Scan Image for Vulnerabilities'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: bun scripts/cli.ts scan-vulnerabilities

      - name: 'Deploy Docker Image to Cloud Run'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: bun scripts/cli.ts deploy-cloudrun

      - name: 'Verify Deployment'
        if: env.CHANGES_DETECTED_AT != 'none'
        run: bun scripts/cli.ts verify-deployment
