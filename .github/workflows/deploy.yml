name: 'Deploy'

# Single workflow that handles both Terraform and Docker deployment
# Pushes to master automatically deploy to dev environment
# Other environments (test, pilot, prod) use image promotion workflow at GitHub
on:
  push:
    branches:
      - master

  # Allow manual trigger in GitHub, useful to test workflow without pushing code
  workflow_dispatch:

jobs:
  deploy:
    name: 'Deploy Infrastructure and Application'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: 'Checkout repository code'
        uses: actions/checkout@v4

      - name: 'Setup Bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: 'Generate Terraform Variables'
        run: bun run generate-tfvars

      - name: 'Detect Environment'
        run: bun scripts/cli.ts detect-env

      - name: 'Validate Config Files'
        run: bun scripts/cli.ts validate

      - name: 'Load Config'
        run: bun scripts/cli.ts load-config --env ${{ env.ENVIRONMENT }} >> $GITHUB_ENV

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v3'
        with:
          workload_identity_provider: 'projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com'

      # ============================================================================
      # TERRAFORM STEPS
      # ============================================================================
      # Terraform is idempotent - if no changes, it completes in ~1 second
      # No need for conditional logic - always run for simplicity

      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: 'Set GCP Project and Enable APIs'
        run: bun scripts/cli.ts setup-gcp

      - name: 'Terraform Format Check'
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ./terraform

      - name: 'Terraform Apply'
        run: bun scripts/cli.ts terraform-apply --env ${{ env.ENVIRONMENT }}

      # ============================================================================
      # DOCKER STEPS
      # ============================================================================
      # Docker build uses cache - rebuilding identical code is fast
      # Always deploy to dev - other envs use image promotion workflow

      - name: 'Docker Auth'
        run: gcloud auth configure-docker '${{ env.REGION }}-docker.pkg.dev'

      - name: 'Set variable for docker tag'
        run: echo "DOCKER_IMAGE_TAG=${{ env.ENVIRONMENT }}" >> $GITHUB_ENV

      - name: 'Build and Push Docker Image to Artifact Registry'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfile.prod
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.ENVIRONMENT }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: 'Scan Image for Vulnerabilities'
        run: bun scripts/cli.ts scan-vulnerabilities

      - name: 'Deploy Docker Image to Cloud Run'
        run: bun scripts/cli.ts deploy-cloudrun

      - name: 'Verify Deployment'
        run: bun scripts/cli.ts verify-deployment
