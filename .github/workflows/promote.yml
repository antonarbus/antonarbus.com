name: 'Promote Release'

# Promotes a tested Docker image from one environment to another
# Instead of rebuilding, copies the exact same image that was tested
on:
  workflow_dispatch:
    inputs:
      source_env:
        description: 'Source environment (where the tested image is)'
        required: true
        type: choice
        options:
          - dev
          - test
          - pilot
      target_env:
        description: 'Target environment (where to deploy)'
        required: true
        type: choice
        options:
          - test
          - pilot
          - prod

jobs:
  validate:
    name: 'Validate Promotion Path'
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Check promotion path'
        id: check
        run: bash .github/scripts/validate-promotion-path.sh "${{ github.event.inputs.source_env }}" "${{ github.event.inputs.target_env }}" >> "$GITHUB_OUTPUT"

      - name: 'Fail if invalid'
        if: steps.check.outputs.valid == 'false'
        run: exit 1

  promote:
    name: 'Promote to ${{ github.event.inputs.target_env }}'
    needs: validate
    runs-on: ubuntu-latest
    # GitHub Environment for approval gates
    # Configure required reviewers in GitHub repo settings -> Environments
    environment: ${{ github.event.inputs.target_env }}

    permissions:
      contents: read
      id-token: write

    env:
      SOURCE_ENV: ${{ github.event.inputs.source_env }}
      TARGET_ENV: ${{ github.event.inputs.target_env }}

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Load target environment config'
        run: bash .github/scripts/get-config-variables.sh "$TARGET_ENV" >> "$GITHUB_ENV"

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v3'
        with:
          workload_identity_provider: 'projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com'

      - name: 'Configure gcloud'
        run: gcloud config set project '${{ env.PROJECT_ID }}'

      - name: 'Promote Docker Image'
        id: promote
        run: bash .github/scripts/promote-image.sh

      - name: 'Deploy promoted image to Cloud Run'
        run: bash .github/scripts/deploy-to-cloudrun.sh
        env:
          DOCKER_IMAGE_TAG: ${{ env.TARGET_ENV }}

      - name: 'Verify Deployment'
        run: bash .github/scripts/verify-deployment.sh

      - name: 'Add promotion summary'
        if: always()
        run: |
          echo "## Release Promotion Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Source**: $SOURCE_ENV" >> "$GITHUB_STEP_SUMMARY"
          echo "**Target**: $TARGET_ENV" >> "$GITHUB_STEP_SUMMARY"
          echo "**Digest**: \`$SOURCE_IMAGE_DIGEST\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Promoted by**: ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ job.status }}" == "success" ]; then
            echo "Status: Promotion successful" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Status: Promotion failed" >> "$GITHUB_STEP_SUMMARY"
          fi
