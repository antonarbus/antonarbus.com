name: 'Promote Release'
run-name: 'Promote ${{ inputs.source_env }} â†’ ${{ inputs.target_env }} by ${{ github.actor }}'

# Promotes a tested Docker image from one environment to another
# Instead of rebuilding, copies the exact same image that was tested
on:
  workflow_dispatch:
    inputs:
      source_env:
        description: 'Source environment (where the tested image is)'
        required: true
        type: choice
        options:
          - dev
          - test
          - pilot
      target_env:
        description: 'Target environment (where to deploy)'
        required: true
        type: choice
        options:
          - test
          - pilot
          - prod

jobs:
  validate:
    name: 'Validate Promotion Path'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Setup Bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: 'Generate Terraform Variables'
        run: bun run generate-tfvars

      - name: 'Check promotion path'
        run: bun scripts/cli.ts validate-promotion --source-env "${{ github.event.inputs.source_env }}" --target-env "${{ github.event.inputs.target_env }}"

  promote:
    name: 'Promote to ${{ github.event.inputs.target_env }}'
    needs: validate
    runs-on: ubuntu-latest
    # GitHub Environment for approval gates
    # Configure required reviewers in GitHub repo settings -> Environments
    environment: ${{ github.event.inputs.target_env }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Setup Bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: 'Generate Terraform Variables'
        run: bun run generate-tfvars

      - name: 'Load target environment config'
        id: config
        run: bun scripts/cli.ts load-config --env "${{ github.event.inputs.target_env }}" >> $GITHUB_OUTPUT

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v3'
        with:
          workload_identity_provider: 'projects/${{ steps.config.outputs.projectNumber }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions-sa@${{ steps.config.outputs.projectId }}.iam.gserviceaccount.com'

      - name: 'Configure gcloud'
        run: gcloud config set project '${{ steps.config.outputs.projectId }}'

      - name: 'Promote Docker Image'
        id: promote
        run: bun scripts/cli.ts promote-image --source-env "${{ github.event.inputs.source_env }}" --target-env "${{ github.event.inputs.target_env }}" >> $GITHUB_OUTPUT

      - name: 'Deploy promoted image to Cloud Run'
        id: deploy
        run: bun scripts/cli.ts deploy-cloudrun --env "${{ github.event.inputs.target_env }}" >> $GITHUB_OUTPUT

      - name: 'Verify Deployment'
        run: bun scripts/cli.ts verify-deployment --env "${{ github.event.inputs.target_env }}" --previous-image "${{ steps.deploy.outputs.PREVIOUS_IMAGE }}"

      - name: 'Add promotion summary'
        if: always()
        run: |
          echo "## Release Promotion Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Source**: ${{ github.event.inputs.source_env }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Target**: ${{ github.event.inputs.target_env }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Digest**: \`${{ steps.promote.outputs.sourceImageDigest }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Promoted by**: ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ job.status }}" == "success" ]; then
            echo "Status: Promotion successful" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Status: Promotion failed" >> "$GITHUB_STEP_SUMMARY"
          fi
